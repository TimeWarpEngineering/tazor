# Razor Compiler Outputs Reference

**Purpose**: Comprehensive documentation of all outputs generated by the Razor compiler, to serve as a baseline reference for the transition to Tazor.

**Target State**:
- Move from `.tazor` → `.tazor` file extension
- Remove SDK dependency (move out of Microsoft.NET.Sdk.Razor)
- Migrate from Blazor components to Terminal UI (TUI) components
- Support .NET 10+ only

---

## 1. Generated File Types

### A. C# Code Files (.g.cs)

**Location**: `Generated/Microsoft.CodeAnalysis.Razor.Compiler/Microsoft.NET.Sdk.Razor.SourceGenerators.RazorSourceGenerator/`

**Naming Convention**: `{ComponentPath}_tazor.g.cs`
- Example: `Components_Pages_Counter_tazor.g.cs` from `Components/Pages/Counter.tazor`
- Example: `Components_App_tazor.g.cs` from `Components/App.tazor`
- Example: `Components__Imports_tazor.g.cs` from `Components/_Imports.tazor`

**Size**: Variable (typically 100-250+ lines per file)

**Content**: Fully compiled C# classes representing Razor components or views

### B. Component Classes (Blazor)

**Base Class**: `ComponentBase` (from `Microsoft.AspNetCore.Components`)

**Generated Methods**:
- `BuildRenderTree(RenderTreeBuilder __builder)` - Primary rendering method
- User-defined C# code blocks from the .tazor file
- Component lifecycle methods

**Attributes**:
- `[RouteAttribute]` for components with `@page` directives
- `[RazorCompiledItem]` metadata attributes
- Custom attributes for component configuration

### C. View/Page Classes (Legacy MVC/Razor Pages)

**Base Class**: `RazorPage<TModel>` or `RazorPageBase`

**Generated Methods**:
- `ExecuteAsync` method (async rendering)
- `Execute` method (synchronous rendering)
- Tag helper binding methods
- Section definitions

### D. Metadata and Source Information

**Checksum Pragma**:
```csharp
#pragma checksum "{filePath}" "{algorithmId}" "{checksum}"
```
- SHA1 or SHA256 checksums for debugger source mapping
- Enables precise source code location tracking

**Line Pragmas**:
```csharp
#line (startLine,startCol)-(endLine,endCol) "filePath"
#line default
#line hidden
```
- Maps generated code locations to original .tazor positions
- Enables breakpoints and accurate stack traces

---

## 2. Generation Pipeline

The Razor compiler follows a 10-phase architecture:

### Phase 1: Parsing (DefaultRazorParsingPhase)
- **Input**: `.tazor` file text content
- **Output**: `RazorSyntaxTree` (raw syntax tokens and structure)
- **Processing**: Tokenizes raw file content, builds syntax tree

### Phase 2: Syntax Tree Processing (DefaultRazorSyntaxTreePhase)
- **Input**: `RazorSyntaxTree`
- **Output**: Enhanced `RazorSyntaxTree` with structure validation
- **Processing**: Validates tree structure, normalizes node positions

### Phase 3: Document Classification (DefaultRazorDocumentClassifierPhase)
- **Input**: `RazorSyntaxTree`
- **Output**: Classified document identifying file kind
- **Determines**: Component files (`.tazor`) vs. View files (`.cshtml`)

### Phase 4: Directive Classification (DefaultRazorDirectiveClassifierPhase)
- **Input**: Classified syntax tree
- **Output**: `RazorSyntaxTree` with classified directives
- **Processes**: `@using`, `@page`, `@layout`, `@inject`, `@model`, custom directives

### Phase 5: Tag Helper Context Discovery (DefaultRazorTagHelperContextDiscoveryPhase)
- **Input**: Classified document + compilation metadata
- **Output**: `TagHelperDocumentContext` with available tag helpers
- **Discovers**: Built-in tag helpers, user-defined tag helpers, component declarations

### Phase 6: Tag Helper Rewriting (DefaultRazorTagHelperRewritePhase)
- **Input**: Document with discovered tag helpers
- **Output**: `RazorSyntaxTree` with rewritten tag helper references
- **Transforms**: `<MyComponent />` syntax to component invocations

### Phase 7: Intermediate Node Lowering (DefaultRazorIntermediateNodeLoweringPhase)
- **Input**: Final syntax tree
- **Output**: `DocumentIntermediateNode` - Abstract Intermediate Representation (IR)
- **Creates**: Document structure, namespace/class/method declarations, component nodes

**Key Intermediate Node Types** (70+ total):
- `DocumentIntermediateNode` - Root node
- `NamespaceDeclarationIntermediateNode` - Namespace container
- `ClassDeclarationIntermediateNode` - Main generated class
- `MethodDeclarationIntermediateNode` - Methods (BuildRenderTree, etc.)
- `ComponentIntermediateNode` - Component usage
- `HtmlContentIntermediateNode` - HTML markup sections
- `CSharpExpressionIntermediateNode` - `@expression` blocks
- `CSharpCodeIntermediateNode` - `@code` or `@{ }` blocks
- `TagHelperIntermediateNode` - Tag helper invocations
- `UsingDirectiveIntermediateNode` - Using statements
- `FieldDeclarationIntermediateNode` - Field definitions
- `PropertyDeclarationIntermediateNode` - Property definitions
- `HtmlAttributeIntermediateNode` - HTML element attributes
- `ComponentAttributeIntermediateNode` - Component properties
- `ComponentChildContentIntermediateNode` - RenderFragment content
- `ReferenceCaptureIntermediateNode` - Template references (@ref)

### Phase 8: Optimization Phase (DefaultRazorOptimizationPhase)
- **Input**: `DocumentIntermediateNode`
- **Output**: Optimized `DocumentIntermediateNode`
- **Optimizations**: Merges consecutive HTML content, pre-computes static content, removes unnecessary nodes

### Phase 9: Code Target Resolution
- **Input**: Optimized intermediate nodes
- **Output**: `CodeTarget` instance (defines code generation strategy)
- **Selects**: Runtime vs. design-time generation mode

### Phase 10: C# Code Generation (DefaultRazorCSharpLoweringPhase)
- **Input**: `DocumentIntermediateNode` + `CodeTarget`
- **Output**: `RazorCSharpDocument` (final generated C# code)
- **Writers Used**:
  - `RuntimeNodeWriter` - Runtime rendering methods
  - `DesignTimeNodeWriter` - Design-time tooling support
  - `ComponentRuntimeNodeWriter` - Component-specific logic
  - `ComponentDesignTimeNodeWriter` - Component design-time

---

## 3. Output Purposes

### A. Component Classes (Runtime)
**Purpose**: Execute rendering logic at runtime

**Contains**:
- `BuildRenderTree` method with `RenderTreeBuilder` calls
- Initialization of component properties from attributes
- Event handler method definitions
- Lifecycle method overrides

**Usage**: Blazor runtime invokes to generate HTML or component tree

### B. View/Page Classes (Legacy MVC/Razor Pages)
**Purpose**: Render HTML content for server-side rendering

**Contains**:
- `ExecuteAsync` method (async rendering)
- Tag helper binding methods
- Section definitions

**Usage**: ASP.NET Core MVC/Razor Pages runtime

### C. Design-Time Code
**Purpose**: IDE tooling support (IntelliSense, diagnostics, refactoring)

**Features**:
- Identifies component parameters
- Maps child content patterns
- Provides accurate symbol information
- Enables "Go to Definition" functionality

**Generated when**: Compilation with design-time flag

### D. Build Artifacts

**Source Mapping**: Maps generated code locations to original .tazor positions
- `SourceMapping` records: Original span → Generated span
- Used by debugger to show correct line numbers
- Enables breakpoints in .tazor files

**Line Pragmas**: `#line` directives for runtime stack traces
- Shows original filename in error messages
- Maintains source fidelity in exceptions

**Checksums**: SHA1/SHA256 hashes
- Verified by debugger for source consistency
- Prevents debugging mismatches

### E. Diagnostics

**Compilation Errors/Warnings**: `RazorDiagnostic` instances
- Syntax errors in Razor markup
- Undefined components or tag helpers
- Invalid directive usage
- Type mismatch issues

**Location Information**: Precise source positions

**Categorized Severity**: Error, Warning, Info, Hidden

---

## 4. Integration Points

### A. MSBuild Integration

**Key Targets** (in .NET SDK):
- `Microsoft.NET.Sdk.Razor.SourceGenerators.targets` - Configures incremental generator
- `Microsoft.NET.Sdk.Razor.CodeGeneration.targets` - Legacy code generation
- `Microsoft.NET.Sdk.Razor.Component.targets` - Component-specific settings
- `Microsoft.NET.Sdk.Razor.Configuration.targets` - Razor language version

**Build Properties**:
- `RazorLangVersion` - Language version (e.g., "9.0")
- `RazorConfiguration` - Configuration name (default: "default")
- `RootNamespace` - Default namespace for components
- `GenerateRazorMetadataSourceChecksumAttributes` - Include metadata
- `SupportLocalizedComponentNames` - Localization support
- `SuppressRazorSourceGenerator` - Disable generation

### B. Source Generators (Roslyn 4.0+)

**Generator Type**: `IIncrementalGenerator`

**Class**: `RazorSourceGenerator` in `Microsoft.NET.Sdk.Razor.SourceGenerators`

**Trigger**: Changes to `.tazor` or `.cshtml` files

**Pipeline**:
1. Parse analyzer config for Razor settings
2. Collect all `.tazor` and `.cshtml` files
3. Filter by import files (`_Imports.tazor`, `_ViewImports.cshtml`)
4. Create declaration-only compilation first
5. Discover tag helpers from declaration compilation
6. Generate full code with discovered tag helpers
7. Output generated files

### C. TagHelper Discovery

**Compilation Scanning**: Looks for types implementing `IComponent` or with `[HtmlTargetElement]`

**Features**: `StaticCompilationTagHelperFeature` analyzes assembly metadata

**Built-ins**: `<Component>`, `<Splat>`, `<CascadingValue>`, etc.

**Result**: `TagHelperDescriptor` list per component

### D. Project Engine Integration

**Type**: `RazorProjectEngine` - Orchestrates compilation

**Features**:
- `IConfigureRazorParserOptionsFeature` - Customize parsing
- `IConfigureRazorCodeGenerationOptionsFeature` - Customize codegen
- `IRazorProjectEngineFeature` - Custom behaviors

**Usage**: Called by source generator for each Razor file

---

## 5. File Locations

### A. Generated Files Directory Structure
```
{ProjectRoot}/Generated/
└── Microsoft.CodeAnalysis.Razor.Compiler/
    └── Microsoft.NET.Sdk.Razor.SourceGenerators.RazorSourceGenerator/
        ├── Components_App_tazor.g.cs
        ├── Components_Pages_Counter_tazor.g.cs
        ├── Components__Imports_tazor.g.cs
        └── ... (one file per .tazor/.cshtml)
```

### B. Intermediate Build Artifacts
**Location**: `obj/{Configuration}/{TargetFramework}/generated/`

**Contents**: Generated C# files (cached during build)

**Cleaned**: During "Clean" build target

### C. Symbol Locations
- **Syntax Trees**: In-memory, not persisted
- **Intermediate Nodes**: In-memory IR tree
- **Source Maps**: Stored in generated C# as pragmas
- **Diagnostics**: Reported through Roslyn diagnostic API

---

## 6. Sample Output Structure

From `Counter.tazor`:
```csharp
#pragma checksum "...Counter.tazor" "{8829d00f-11b8-4213-878b-770e8597ac16}" "..."
// <auto-generated/>
// Generated by TimeWarp.Tazor - A high-performance Razor compiler fork
#pragma warning disable 1591

namespace TestBlazorApp.Components.Pages
{
    #line default
    using global::System;
    using global::System.Collections.Generic;
    using global::System.Linq;
    using global::System.Threading.Tasks;
    using global::Microsoft.AspNetCore.Components;

    #line default
    #line hidden

    [global::Microsoft.AspNetCore.Components.RouteAttribute("/counter")]
    #nullable restore
    public partial class Counter : global::Microsoft.AspNetCore.Components.ComponentBase
    #nullable disable
    {
        #pragma warning disable 1998
        protected override void BuildRenderTree(
            global::Microsoft.AspNetCore.Components.Rendering.RenderTreeBuilder __builder)
        {
            __builder.OpenComponent<...PageTitle...>(0);
            __builder.AddAttribute(1, "ChildContent", ...);
            __builder.CloseComponent();

            __builder.AddMarkupContent(3, "<h1>Counter</h1>\r\n\r\n");
            __builder.OpenElement(5, "p");
            __builder.AddAttribute(6, "role", "status");
            __builder.AddContent(7, "Current count: ");

            #nullable restore
            #line (8,34)-(8,46) "...Counter.tazor"
            __builder.AddContent(8, currentCount);
            #line default
            #nullable disable

            __builder.CloseElement();
            // ... more builder calls
        }
        #pragma warning restore 1998

        #nullable restore
        #line (13,8)-(16,1) "...Counter.tazor"
        private int currentCount = 0;
        private void IncrementCount() { currentCount++; }
        #line default
        #nullable disable
    }
}
#pragma warning restore 1591
```

---

## 7. Key Components and Files

### Core Generation Classes
- `DefaultRazorCSharpLoweringPhase.cs` - Final C# generation
- `CodeWriter.cs` - Text output buffering
- `IntermediateNodeWriter.cs` - Base writer interface
- `RuntimeNodeWriter.cs` - Runtime code generation
- `DesignTimeNodeWriter.cs` - Design-time code

### Source Generator
- `RazorSourceGenerator.cs` - Main incremental generator
- `SourceGeneratorProjectEngine.cs` - Execution wrapper

### Data Structures
- `RazorCodeDocument.cs` - Input document container
- `RazorCSharpDocument.cs` - Output C# + metadata
- `SourceMapping.cs` - Position mapping
- `LinePragma.cs` - Line directives

### Intermediate Representation
- `src/Compiler/Microsoft.CodeAnalysis.Razor.Compiler/src/Language/Intermediate/` - 70+ IR node types

---

## 8. Output Characteristics

**Encoding**: UTF-8 with BOM

**Line Endings**: Platform-specific (CRLF on Windows, LF on Unix)

**Indentation**: 4 spaces (configurable via `RazorCodeGenerationOptions`)

**Nullable Context**: Preserved from source directives

**Auto-generated Marker**: Comment header identifies generated files

**Warnings Suppressed**: XML doc warning (#1591) suppressed globally

---

## 9. Transition Considerations for Tazor

### Changes Needed for `.tazor` → `.tazor`

1. **File Detection**
   - Update source generator to look for `*.tazor` files
   - Update MSBuild targets to include `*.tazor` in compilation
   - Modify `_Imports.tazor` → `_Imports.tazor` discovery

2. **Naming Convention**
   - Change `{Path}_tazor.g.cs` → `{Path}_tazor.g.cs`
   - Update internal references and diagnostics

3. **SDK Independence**
   - Remove dependency on `Microsoft.NET.Sdk.Razor`
   - Create standalone `Microsoft.NET.Sdk.Tazor` (or no SDK requirement)
   - Implement custom MSBuild targets

4. **TUI vs Blazor Components**
   - Replace `ComponentBase` with TUI base class
   - Change `BuildRenderTree(RenderTreeBuilder)` to TUI rendering model
   - Remove HTML/DOM-specific generation
   - Implement terminal control generation

5. **Target Framework**
   - Remove support for net472, netstandard2.0, net8.0, net9.0
   - Focus exclusively on net10.0+
   - Leverage new C# language features

6. **Generated Code Style**
   - Update branding comment
   - Consider different output structure for TUI
   - Optimize for terminal rendering performance

---

This document serves as the baseline reference for understanding the complete Razor compilation pipeline and its outputs, enabling systematic transition to Tazor.
